# $Date$ $Author$ $Revision$
# Makefile fuer Runtime
#

SHELL   = /bin/bash

JAVAC   = @javac@
JFLAGS  = -g -O #+E
RMIC    = rmic
RMIFLAGS= -v1.2

M4      = @m4@
M4INCL  = $(SRCDIR)/macros.m4
SRCDIR  = @srcdir@

CLASSROOT  = ../../classes/
RUNTIME = de/uni_sb/ps/dml/runtime/
TOOLS   = de/uni_sb/ps/dml/tools/
rt      = de.uni_sb.ps.dml.runtime.

tools = $(CLASSROOT)$(TOOLS)Exec.class

files = $(CLASSROOT)$(RUNTIME)Array.class \
	$(CLASSROOT)$(RUNTIME)Builtin.class \
	$(CLASSROOT)$(RUNTIME)ByNeedFuture.class \
	$(CLASSROOT)$(RUNTIME)CManager.class \
	$(CLASSROOT)$(RUNTIME)Char.class \
	$(CLASSROOT)$(RUNTIME)ClientManager.class \
	$(CLASSROOT)$(RUNTIME)ConVal.class \
	$(CLASSROOT)$(RUNTIME)ConVal2.class \
	$(CLASSROOT)$(RUNTIME)ConVal3.class \
	$(CLASSROOT)$(RUNTIME)ConVal4.class \
	$(CLASSROOT)$(RUNTIME)Connection.class \
	$(CLASSROOT)$(RUNTIME)Cons.class \
	$(CLASSROOT)$(RUNTIME)Constants.class \
	$(CLASSROOT)$(RUNTIME)Constructor.class \
	$(CLASSROOT)$(RUNTIME)DMLConVal.class \
	$(CLASSROOT)$(RUNTIME)DMLPort.class \
	$(CLASSROOT)$(RUNTIME)DMLTransient.class \
	$(CLASSROOT)$(RUNTIME)DMLTuple.class \
	$(CLASSROOT)$(RUNTIME)DMLValue.class \
	$(CLASSROOT)$(RUNTIME)ExceptionWrapper.class \
	$(CLASSROOT)$(RUNTIME)Export.class \
	$(CLASSROOT)$(RUNTIME)Exporter.class \
	$(CLASSROOT)$(RUNTIME)Function.class \
	$(CLASSROOT)$(RUNTIME)Future.class \
	$(CLASSROOT)$(RUNTIME)GName.class \
	$(CLASSROOT)$(RUNTIME)General.class \
	$(CLASSROOT)$(RUNTIME)Int.class \
	$(CLASSROOT)$(RUNTIME)JObject.class \
	$(CLASSROOT)$(RUNTIME)LVar.class \
	$(CLASSROOT)$(RUNTIME)List.class \
	$(CLASSROOT)$(RUNTIME)Math.class \
	$(CLASSROOT)$(RUNTIME)Name.class \
	$(CLASSROOT)$(RUNTIME)NoGood.class \
	$(CLASSROOT)$(RUNTIME)Option.class \
	$(CLASSROOT)$(RUNTIME)PickleClassLoader.class \
	$(CLASSROOT)$(RUNTIME)PickleInputStream.class \
	$(CLASSROOT)$(RUNTIME)PickleOutputStream.class \
	$(CLASSROOT)$(RUNTIME)Port.class \
	$(CLASSROOT)$(RUNTIME)Real.class \
	$(CLASSROOT)$(RUNTIME)Record.class \
	$(CLASSROOT)$(RUNTIME)RecordArity.class \
	$(CLASSROOT)$(RUNTIME)Reference.class \
	$(CLASSROOT)$(RUNTIME)SManager.class \
	$(CLASSROOT)$(RUNTIME)ServerManager.class \
	$(CLASSROOT)$(RUNTIME)String.class \
	$(CLASSROOT)$(RUNTIME)StringCvt.class \
	$(CLASSROOT)$(RUNTIME)TextIO.class \
	$(CLASSROOT)$(RUNTIME)Thread.class \
	$(CLASSROOT)$(RUNTIME)Tuple.class \
	$(CLASSROOT)$(RUNTIME)Tuple2.class \
	$(CLASSROOT)$(RUNTIME)Tuple3.class \
	$(CLASSROOT)$(RUNTIME)Tuple4.class \
	$(CLASSROOT)$(RUNTIME)UniqueConstructor.class \
	$(CLASSROOT)$(RUNTIME)UniqueName.class \
	$(CLASSROOT)$(RUNTIME)Vector.class \
	$(CLASSROOT)$(RUNTIME)Word.class

rmifil= $(CLASSROOT)$(RUNTIME)LVar_Stub.class \
	$(CLASSROOT)$(RUNTIME)Future_Stub.class \
	$(CLASSROOT)$(RUNTIME)ByNeedFuture_Stub.class \
	$(CLASSROOT)$(RUNTIME)ServerManager_Stub.class \
	$(CLASSROOT)$(RUNTIME)ClientManager_Stub.class \
	$(CLASSROOT)$(RUNTIME)Exporter_Stub.class \
	$(CLASSROOT)$(RUNTIME)Port_Stub.class

rmipatch = $(CLASSROOT)sun/rmi/server/MarshalOutputStream.class \
	   $(CLASSROOT)sun/rmi/server/MarshalInputStream.class

all:    link @runtime@ @patch@

@runtime@:      $(files) $(tools) $(rmifil) $(M4INCL) $(rmipatch)
	rm @runtime@; \
	(cd $(CLASSROOT); jar cf @runtime@ de)

@patch@:         $(files) $(tools) $(rmifil) $(M4INCL) $(rmipatch)
	rm @patch@; \
	(cd $(CLASSROOT); jar cf @patch@ sun)

link:
	test -d $(CLASSROOT) || mkdir $(CLASSROOT)
	(test -d $(CLASSROOT)$(RUNTIME) || for a in $(SRCDIR)/*.java.m4 ; do \
	$(M4) $(M4INCL) $$a > `basename $$a .m4` ; done)
	test -d $(CLASSROOT)$(RUNTIME) || (\
	CLASSPATH=$(CLASSROOT):$(CLASSPATH) $(JAVAC) $(JFLAGS) -d $(CLASSROOT) *java && \
	CLASSPATH=$(CLASSROOT):$(CLASSPATH) $(RMIC) $(RMIFLAGS) -d $(CLASSROOT) $(rt)LVar $(rt)Future $(rt)ServerManager $(rt)ClientManager $(rt)Exporter $(rt)Port $(rt)ByNeedFuture)

clean:
	rm *.java; \
	exit 0

distclean: clean
	rm -r $(CLASSROOT) ; \
	rm @patch@ @runtime@ ; \
	exit 0

veryclean:      distclean
	rm Makefile; exit 0

$(files): $(CLASSROOT)$(RUNTIME)%.class : $(SRCDIR)/%.java.m4
	$(M4) $(M4INCL) $< > `basename $< .m4`
	CLASSPATH=$(CLASSROOT):$(CLASSPATH) $(JAVAC) $(JFLAGS) -d $(CLASSROOT) `basename $< .m4`

$(tools): $(CLASSROOT)$(TOOLS)%.class : $(SRCDIR)/%.java.m4
	$(M4) $(M4INCL) $< > `basename $< .m4`
	CLASSPATH=$(CLASSROOT):$(CLASSPATH) $(JAVAC) $(JFLAGS) -d $(CLASSROOT) `basename $< .m4`

$(rmifil): $(CLASSROOT)$(RUNTIME)%_Stub.class : $(CLASSROOT)$(RUNTIME)%.class
	CLASSPATH=$(CLASSROOT):$(CLASSPATH) $(RMIC) $(RMIFLAGS) -d $(CLASSROOT) $(rt)`basename $< .class`

$(CLASSROOT)sun/rmi/server/MarshalOutputStream.class : $(SRCDIR)/MarshalOutputStream.java.m4
	$(M4) $(M4INCL) $< > `basename $< .m4`
	CLASSPATH=$(CLASSROOT):$(CLASSPATH) $(JAVAC) $(JFLAGS) -d $(CLASSROOT) `basename $< .m4`

$(CLASSROOT)sun/rmi/server/MarshalInputStream.class : $(SRCDIR)/MarshalInputStream.java.m4
	$(M4) $(M4INCL) $< > `basename $< .m4`
	CLASSPATH=$(CLASSROOT):$(CLASSPATH) $(JAVAC) $(JFLAGS) -d $(CLASSROOT) `basename $< .m4`
