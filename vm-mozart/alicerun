#!/bin/sh

set -e

find_in () {
    local search_for=$1 found_in=""
    shift
    for d in $@; do
	if test -f $d/${search_for} -o -h $d/${search_for}; then
	    found_in=$d && break
	fi
    done
    if test -z "${found_in}"; then
	echo "Error: Could not find ${search_for} in either of" >&2
	for d in $@; do echo "  $d" >&2; done
	exit 1
    fi
    echo ${found_in}
}

if test -z "${STOCKHOME}"; then
    STOCKHOME=$(find_in VMMain.ozf /usr/share/alice $(dirname $(dirname $0)))
fi

if test -z "${OZHOME}"; then
    OZHOME=$(find_in share/Init.ozf /usr/lib/mozart /opt/mozart-devel)
fi

case $(uname) in
    CYGWIN*)
	: ${OZ_LOAD:=prefix=/=c:/cygwin/\;cache=$OZHOME/cache/}
	SEP=\;
	ESC=
	;;
    *)
	: ${OZ_LOAD:=cache=$OZHOME/cache/}
	SEP=:
	ESC=\\
	;;
esac

ALICE_LOAD=pattern=x-oz:'?{x}'=x-oz${ESC}:'?{x}'${SEP}pattern='?{x}'='?{x}.ozf'${SEP}pattern='?{x}'='?{x}'${SEP}pattern=x-alice:/'?{x}'=$STOCKHOME/'?{x}'.ozf${SEP}pattern=x-alice:/'?{x}'=$STOCKHOME/'?{x}'

OZ_LOAD=$ALICE_LOAD${SEP}$OZ_LOAD

export STOCKHOME OZ_LOAD ALICE_LOAD

exec ozengine x-alice:/VMMain "$@"
