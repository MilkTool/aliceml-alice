#!/bin/sh

set -e

cmd="$0"

find_in () {
    search_for=$1
    found_in=""
    shift
    for d in "$@"; do
	if test -f "$d/${search_for}" -o -h "$d/${search_for}"; then
	    found_in=$d && break
	fi
    done
    if test -z "${found_in}"; then
	echo "$cmd: error: could not find ${search_for} in either of" >&2
	for d in "$@"; do echo "  $d" >&2; done
	exit 1
    fi
    echo "${found_in}"
}

abs_path () {
    case "$1" in
	/*|?:*)
	    echo "$1"
	    ;;
	*)
	    echo "$(pwd)/$1"
	    ;;
    esac
}

if test -z "${ALICE_HOME}"; then
    dir=$(dirname "$0")
    dir=$(dirname "$dir")
    ALICE_HOME=$(find_in alice.dll /usr/share/alice "$PROGRAMFILES/Alice" "$dir")
fi
ALICE_HOME=$(abs_path "$ALICE_HOME")

if test -z "${SEAM_HOME}"; then
    SEAM_HOME=$(find_in seam.exe "$PROGRAMFILES/Seam/bin")
    SEAM_HOME=$(dirname "$SEAM_HOME")
fi
SEAM_HOME=$(abs_path "$SEAM_HOME")

case $(uname) in
    CYGWIN*)
	PATH="$ALICE_HOME:$PATH"
	ALICE_HOME=`cygpath -m "$ALICE_HOME"`
	sep=\;
	;;
    *)
	if [ -z "$LD_LIBRARY_PATH" ]
	then
	    LD_LIBRARY_PATH="$SEAM_HOME/bin:$ALICE_HOME"
	else
	    LD_LIBRARY_PATH="$SEAM_HOME/bin:$ALICE_HOME:$LD_LIBRARY_PATH"
	fi
	export LD_LIBRARY_PATH
	sep=:
	;;
esac

ALICE_LOAD=cache=$HOME/.alice/cache${sep}pattern=?{x}=?{x}.stc${sep}pattern=?{x}=?{x}.dll

if [ ! -z "$ALICE_LOAD_PREFIX" ]
then
    ALICE_LOAD="$ALICE_LOAD_PREFIX${sep}$ALICE_LOAD"
fi
if [ ! -z "$ALICE_LOAD_SUFFIX" ]
then
    ALICE_LOAD="$ALICE_LOAD${sep}$ALICE_LOAD_SUFFIX"
fi

export ALICE_HOME ALICE_LOAD

## To use the GUI debugger on Windows/Cygwin:
#echo run alice "$@"
#exec insight "$SEAM_HOME"/bin/seam.exe

## To use the debugger on Unix:
#(echo "break Base.cc:22"; echo "tty /dev/pts/4"; echo run alice "$@"; cat) |
#exec gdb "$SEAM_HOME"/bin/seam.exe

exec "$SEAM_HOME"/bin/seam.exe alice "$@"
